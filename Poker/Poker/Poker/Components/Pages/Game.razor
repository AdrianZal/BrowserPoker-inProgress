@page "/game/{JoinCode}"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.AspNetCore.Http
@using Poker.Models.DTOs
@using System.Net
@attribute [Authorize]
@implements IAsyncDisposable
@inject NavigationManager Navigation
@inject IHttpContextAccessor HttpContextAccessor
@inject GameService GameService
@inject IJSRuntime JS

<PageTitle>Game</PageTitle>

@if (gameState == null)
{
    <div class="loading">
        <h1>Loading table...</h1>
    </div>
}
else
{
        <div>
            <div style="position: relative; width: 55%; margin: 0 auto;">
                <img src="images/tables/basic.png" alt="Poker Table" style="width: 100%; height: auto; display: block;" />

                <!--Players loop-->
                @for(int i=0; i<gameState.Players.Count; i++)
                {
                    <div class="card-pair @($"card-pair{positions[i]}")" @onpointerdown="() => cardsClicked = true" @onpointerup="()=>cardsClicked=false" @onpointerleave="()=>cardsClicked=false">
                        @if (gameState.Players[i].name == currentUserName
                                    && gameState.Players[i].cards.Count() == 2
                                    || (gameState.Stage == Poker.Game.Table.GameStage.GameOver && gameState.Statuses.ElementAt(i).Value == Poker.Game.Table.PlayerStatus.Showing))
                        {
                            if (hidden && !cardsClicked && gameState.Players[i].name == currentUserName && gameState.Statuses.ElementAt(i).Value != Poker.Game.Table.PlayerStatus.Showing)
                            {
                                <img src="@($"images/cardReverses/{gameState.Players[i].skinFilename}")" alt="card1" />
                                <img src="@($"images/cardReverses/{gameState.Players[i].skinFilename}")" alt="card2" />
                            }
                            else
                            {
                                <img src="@($"images/cardFaces/default/{gameState.Players[i].cards[0].Value}{gameState.Players[i].cards[0].Suit}.png")" alt="card1" />
                                <img src="@($"images/cardFaces/default/{gameState.Players[i].cards[1].Value}{gameState.Players[i].cards[1].Suit}.png")" alt="card2" />
							}
                        }
                        else if (gameState.Players[i].cards.Count() == 2)
                        {
                            <img src="@($"images/cardReverses/{gameState.Players[i].skinFilename}")" alt="card1" />
                            <img src="@($"images/cardReverses/{gameState.Players[i].skinFilename}")" alt="card2" />
                        }
					</div>

                    <div class="@($"name{positions[i]}")">
                        @if (gameState.CurrentPlayer != null && gameState.CurrentPlayer.name == gameState.Players[i].name)
                        {
                            <h1 style="color: lawngreen">@gameState.Players[i].name</h1>
                        }
                        else
                        {
                            <h1 style="color: red">@gameState.Players[i].name</h1>
                        }
                    </div>

                    <div class="balance @($"balance{positions[i]}")">
                        <h1>@gameState.Players[i].tableBalance</h1>
                    </div>

                    <div class="bet @($"bet{positions[i]}")">
                        @if (gameState.PlayerBets.Count() != 0 && gameState.Stage != Poker.Game.Table.GameStage.NotPlayable && gameState.Stage != Poker.Game.Table.GameStage.NotStarted)
                        {
                            <h1>@gameState.PlayerBets.ElementAt(i).Value</h1>
                        }
                    </div>

                    <div class="@($"token{positions[i]}")">
                        @if (gameState.Roles.Count() != 0 && gameState.Roles.ElementAt(i).Value == Poker.Game.Table.PlayerRole.Dealer)
                        {
                            <img src="images/dealerTokens/default.png" alt="token" />
                        }
                    </div>
				}
	
                <!-- pot/winners -->
                @if (gameState.HandWinners.Count() == 0)
                {
                    <div style="position: absolute; bottom: 62%; left: 50%; right: 0; display: flex; justify-content: center; gap: 5px; transform: translateX(-50%);">
                        <h1 style="color: orange">@gameState.Pot</h1>
                    </div>
                }
                else
                {
                    <div class="winners">
                        @if (gameState.WinningHand != string.Empty)
                        {
                            <h1 style="color: cyan">@gameState.WinningHand</h1>
                        }
                        @foreach(var winner in gameState.HandWinners)
                        {
                            <h1 style="color: gold">@winner.Key: @winner.Value</h1>
					    }
                    </div>
                }
               
                

                <!-- table card 1 -->
                <div style="position: absolute; bottom: 37%; left: 31%; right: 0; width: 9%; display: flex; justify-content: center; transform: translateX(-50%);">
                    @if (gameState.TableCards != null && gameState.TableCards.Count > 0)
                    {
                        <img src="@($"images/cardFaces/default/{gameState.TableCards[0].Value}{gameState.TableCards[0].Suit}.png")" alt="card1" style="width: 100%; height: auto;" />
                    }
                </div>

                <!-- table card 2 -->
                <div style="position: absolute; bottom: 37%; left: 40.5%; right: 0; width: 9%; display: flex; justify-content: center; transform: translateX(-50%);">
                    @if (gameState.TableCards != null && gameState.TableCards.Count > 1)
                    {
                        <img src="@($"images/cardFaces/default/{gameState.TableCards[1].Value}{gameState.TableCards[1].Suit}.png")" alt="card1" style="width: 100%; height: auto;" />
                    }
                </div>

                <!-- table card 3 -->
                <div style="position: absolute; bottom: 37%; left: 50%; right: 0; width: 9%; display: flex; justify-content: center; transform: translateX(-50%);">
                    @if (gameState.TableCards != null && gameState.TableCards.Count > 2)
                    {
                        <img src="@($"images/cardFaces/default/{gameState.TableCards[2].Value}{gameState.TableCards[2].Suit}.png")" alt="card1" style="width: 100%; height: auto;" />
                    }
                </div>

                <!-- table card 4 -->
                <div style="position: absolute; bottom: 37%; left: 59.5%; right: 0; width: 9%; display: flex; justify-content: center; transform: translateX(-50%);">
                    @if (gameState.TableCards != null && gameState.TableCards.Count > 3)
                    {
                        <img src="@($"images/cardFaces/default/{gameState.TableCards[3].Value}{gameState.TableCards[3].Suit}.png")" alt="card1" style="width: 100%; height: auto;" />
                    }
                </div>

                <!-- table card 5 -->
                <div style="position: absolute; bottom: 37%; left: 69%; right: 0; width: 9%; display: flex; justify-content: center; transform: translateX(-50%);">
                    @if (gameState.TableCards != null && gameState.TableCards.Count > 4)
                    {
                        <img src="@($"images/cardFaces/default/{gameState.TableCards[4].Value}{gameState.TableCards[4].Suit}.png")" alt="card1" style="width: 100%; height: auto;" />
                    }
                </div>
            </div>

            @if (gameState.Stage == Poker.Game.Table.GameStage.NotPlayable)
            {
                <div class="start-button">
                    <img src=@startButtonImage alt="Start" />
                </div>
            }
            else if (gameState.Stage == Poker.Game.Table.GameStage.NotStarted)
            {
                <div class="start-button">
                    <img src=@startButtonImage alt="Start"
                         @onpointerleave="() => OffButton(Button.Start)"
                         @onpointerenter="() => OverButton(Button.Start)"
                         @onpointerdown="() => ClickButton(Button.Start)"
                         @onpointerup="() => OverButton(Button.Start)">
                </div>
            }


            <div class="hide-button">
                <img src=@hideButtonImage alt="Hide/Show"
                     @onpointerdown="() => ClickButton(Button.Hide)">
            </div>

            @if (gameState != null && gameState.Stage == Poker.Game.Table.GameStage.GameOver && gameState.Statuses[currentUserName] == Poker.Game.Table.PlayerStatus.Folded)
            {
            <div style="display:flex; justify-content:center; gap:1%; margin-top:10px;">
                <img src=@showButtonImage alt="Show" style="width:8%; height:auto;"
                     @onpointerleave="() => OffButton(Button.Show)"
                     @onpointerenter="() => OverButton(Button.Show)"
                     @onpointerdown="() => ClickButton(Button.Show)"
                     @onpointerup="() => OverButton(Button.Show)">
            </div>
            }
            else if (!rising)
            {
                <div style="display:flex; justify-content:center; gap:1%; margin-top:10px;">
                    <img src=@checkCallButtonImage alt="CheckCall" style="width:8%; height:auto;"
                         @onpointerleave="() => OffButton(Button.CheckCall)"
                         @onpointerenter="() => OverButton(Button.CheckCall)"
                         @onpointerdown="() => ClickButton(Button.CheckCall)"
                         @onpointerup="() => OverButton(Button.CheckCall)">
                    <img src=@raiseButtonImage alt="Raise" style="width:8%; height:auto;"
                         @onpointerleave="() => OffButton(Button.Raise)"
                         @onpointerenter="() => OverButton(Button.Raise)"
                         @onpointerdown="() => ClickButton(Button.Raise)"
                         @onpointerup="() => OverButton(Button.Raise)">
                    <img src=@foldButtonImage alt="Fold" style="width:8%; height:auto;"
                         @onpointerleave="() => OffButton(Button.Fold)"
                         @onpointerenter="() => OverButton(Button.Fold)"
                         @onpointerdown="() => ClickButton(Button.Fold)"
                         @onpointerup="() => OverButton(Button.Fold)">
                </div>
            }
            else
            {
                <div style="display:flex; justify-content:center; gap:1%; margin-top:10px;">
                    <img src=@cancelButtonImage alt="Cancel" style="width:4%; height:auto;"
                         @onpointerleave="() => OffButton(Button.Cancel)"
                         @onpointerenter="() => OverButton(Button.Cancel)"
                         @onpointerdown="() => ClickButton(Button.Cancel)"
                         @onpointerup="() => OverButton(Button.Cancel)">
                    <img src=@minusButtonImage alt="Minus" style="width:4%; height:auto;"
                         @onpointerleave="() => OffButton(Button.Minus)"
                         @onpointerenter="() => OverButton(Button.Minus)"
                         @onpointerdown="() => ClickButton(Button.Minus)"
                         @onpointerup="() => OverButton(Button.Minus)">

                    <div style="position: relative; width: 8%; display: inline-block;">
                        <img src="images/buttons/inputField.png" alt="InputField" style="width: 100%; height: auto; display: block;" />

						<input class="no-arrows" type="number" @bind="raiseAmount"
                               style="position: absolute;
                                  top: 50%;
                                  left: 50%;
                                  transform: translate(-50%, -50%);
                                  width: 80%;
                                  background: transparent;
                                  border: none;
                                  text-align: center;
                                  outline: none;" />
                    </div>

                    <img src=@plusButtonImage alt="Plus" style="width:4%; height:auto;"
                         @onpointerleave="() => OffButton(Button.Plus)"
                         @onpointerenter="() => OverButton(Button.Plus)"
                         @onpointerdown="() => ClickButton(Button.Plus)"
                         @onpointerup="() => OverButton(Button.Plus)">
                    <img src=@okButtonImage alt="Ok" style="width:4%; height:auto;"
                         @onpointerleave="() => OffButton(Button.Ok)"
                         @onpointerenter="() => OverButton(Button.Ok)"
                         @onpointerdown="() => ClickButton(Button.Ok)"
                         @onpointerup="() => OverButton(Button.Ok)">
				</div>
            }

        </div>
}

@code {

    [Parameter] public string JoinCode { get; set; } = string.Empty;
    private HubConnection? hubConnection;
    private GameStateDto? gameState;
    private string currentUserName;
    private string whoseTurn = string.Empty;

    private string[] positions = {"-top-right", "-mid-right", "-bot-right", "-mid", "-bot-left", "-mid-left", "-top-left"};

    private bool cardsClicked = false;
    private bool hidden = false;
    private bool rising = false;
    private int _raiseAmount = 0;
    private int raiseAmount
    {
        get => _raiseAmount;
        set
        {
            if (gameState != null)
            {
                var myPlayer = gameState.Players.First(p => p.name == currentUserName);
                if (myPlayer != null)
                {
                    int myBalance = myPlayer.tableBalance;

                    if (value > myBalance - (gameState.ToCall - gameState.PlayerBets[currentUserName]))
                    {
                        _raiseAmount = myBalance - (gameState.ToCall - gameState.PlayerBets[currentUserName]);
                    }
                    else if (value < gameState.MinRaise && myBalance > gameState.MinRaise)
                    {
                        _raiseAmount = gameState.MinRaise;
                    }
                    else
                    {
                        _raiseAmount = value;
                    }
                    return;
                }
            }
            _raiseAmount = value;
        }
    }
    private int plusMinusStep = 0;

    private string startButtonImage = "images/buttons/startOff.png";
    private string checkCallButtonImage = "images/buttons/checkOff.png";
    private string raiseButtonImage = "images/buttons/raiseOff.png";
    private string foldButtonImage = "images/buttons/foldOff.png";
    private string hideButtonImage = "images/buttons/shown.png";

    private string cancelButtonImage = "images/buttons/cancelOff.png";
    private string minusButtonImage = "images/buttons/minusOff.png";
    private string plusButtonImage = "images/buttons/plusOff.png";
    private string okButtonImage = "images/buttons/okOff.png";

    private string showButtonImage = "images/buttons/showOff.png";

    private enum Button
    {
        Start,
        CheckCall,
        Raise,
        Fold,
        Cancel,
        Minus,
        Plus,
        Ok,
        Show,
        Hide
    }

    private void OffButton(Button button)
    {
        switch (button)
        {
            case Button.Start:
                startButtonImage = "images/buttons/startOff.png";
                break;
            case Button.CheckCall:
                if (gameState != null && gameState.Statuses.Count() != 0 && gameState.Statuses[currentUserName] == Poker.Game.Table.PlayerStatus.ToCall)
                {
                    checkCallButtonImage = "images/buttons/callOff.png";
                }
                else
                {
                    checkCallButtonImage = "images/buttons/checkOff.png";
                }
                break;
            case Button.Raise:
                raiseButtonImage = "images/buttons/raiseOff.png";
                break;
            case Button.Fold:
                foldButtonImage = "images/buttons/foldOff.png";
                break;
            case Button.Cancel:
                cancelButtonImage = "images/buttons/cancelOff.png";
                break;
            case Button.Minus:
                minusButtonImage = "images/buttons/minusOff.png";
                break;
            case Button.Plus:
                plusButtonImage = "images/buttons/plusOff.png";
                break;
            case Button.Ok:
                okButtonImage = "images/buttons/okOff.png";
                break;
            case Button.Show:
                showButtonImage = "images/buttons/showOff.png";
                break;
        }
    }

    private void OverButton(Button button)
    {
        switch(button)
        {
            case Button.Start:
                startButtonImage = "images/buttons/startOn.png";
                break;
            case Button.CheckCall:
                if (gameState != null && gameState.Statuses.Count() != 0 && gameState.Statuses[currentUserName] == Poker.Game.Table.PlayerStatus.ToCall)
                {
                    checkCallButtonImage = "images/buttons/callOn.png";
                }
                else
                {
                    checkCallButtonImage = "images/buttons/checkOn.png";
                }
                break;
            case Button.Raise:
                raiseButtonImage = "images/buttons/raiseOn.png";
                break;
            case Button.Fold:
                foldButtonImage = "images/buttons/foldOn.png";
                break;
            case Button.Cancel:
                cancelButtonImage = "images/buttons/cancelOn.png";
                break;
            case Button.Minus:
                minusButtonImage = "images/buttons/minusOn.png";
                break;
            case Button.Plus:
                plusButtonImage = "images/buttons/plusOn.png";
                break;
            case Button.Ok:
                okButtonImage = "images/buttons/okOn.png";
                break;
            case Button.Show:
                showButtonImage = "images/buttons/showOn.png";
                break;
        }
    }

    private void ClickButton(Button button)
    {
        switch (button)
        {
            case Button.Start:
                JS.InvokeVoidAsync("playAudio", "sounds/click.mp3");
                startButtonImage = "images/buttons/startClick.png";
                if (gameState != null && gameState.Stage == Poker.Game.Table.GameStage.NotStarted)
                {
                    hubConnection?.InvokeAsync("StartGame", JoinCode);
                }
                break;
            case Button.CheckCall:
                JS.InvokeVoidAsync("playAudio", "sounds/click.mp3");
                if (gameState != null && gameState.Statuses.Count() != 0 && gameState.Statuses[currentUserName] == Poker.Game.Table.PlayerStatus.ToCall)
                {
                    checkCallButtonImage = "images/buttons/callClick.png";
                }
                else
                {
                    checkCallButtonImage = "images/buttons/checkClick.png";
                }
                if (gameState != null && gameState.CurrentPlayer != null && gameState.CurrentPlayer.name == currentUserName)
                {
                    hubConnection?.InvokeAsync("SendAction", currentUserName, Poker.Game.Table.Decision.Call, 0);
                }
                break;
            case Button.Raise:
                JS.InvokeVoidAsync("playAudio", "sounds/click.mp3");
                raiseButtonImage = "images/buttons/raiseClick.png";
                if(gameState != null && gameState.CurrentPlayer != null && gameState.CurrentPlayer.name == currentUserName)
                {
                    raiseAmount = gameState.MinRaise;
                    OffButton(Button.Cancel);
                    OffButton(Button.Ok);
                    rising = true;
                }
                break;
            case Button.Fold:
                JS.InvokeVoidAsync("playAudio", "sounds/click.mp3");
                foldButtonImage = "images/buttons/foldClick.png";
                if (gameState != null && gameState.CurrentPlayer != null && gameState.CurrentPlayer.name == currentUserName)
                {
                    hubConnection?.InvokeAsync("SendAction", currentUserName, Poker.Game.Table.Decision.Fold, 0);
                }
                break;
            case Button.Cancel:
                JS.InvokeVoidAsync("playAudio", "sounds/click.mp3");
                cancelButtonImage = "images/buttons/cancelClick.png";
                OffButton(Button.Raise);
                rising = false;
                break;
            case Button.Minus:
                JS.InvokeVoidAsync("playAudio", "sounds/coinMinus.mp3");
                minusButtonImage = "images/buttons/minusClick.png";
                if (gameState != null)
                {
                    if (raiseAmount - plusMinusStep >= gameState.MinRaise)
                    {
                        raiseAmount -= plusMinusStep;
                    }
                    else
                    {
                        raiseAmount = gameState.MinRaise;
                    }
                }
                break;
            case Button.Plus:
                JS.InvokeVoidAsync("playAudio", "sounds/coinPlus.mp3");
                plusButtonImage = "images/buttons/plusClick.png";
                if (gameState != null)
                {
                    var balance = gameState.Players.First(p => p.name == currentUserName).tableBalance;

                    if (raiseAmount + plusMinusStep <= balance)
                    {
                        raiseAmount += plusMinusStep;
                    }
                    else
                    {
                        raiseAmount = balance;
                    }
                }
                break;
            case Button.Ok:
                JS.InvokeVoidAsync("playAudio", "sounds/click.mp3");
                okButtonImage = "images/buttons/okClick.png";
                if (gameState != null && gameState.CurrentPlayer != null && gameState.CurrentPlayer.name == currentUserName)
                {
                    var myBalance = gameState.Players.First(p => p.name == currentUserName).tableBalance;

                    if (raiseAmount + gameState.ToCall > myBalance)
                        raiseAmount = myBalance;
                    else if (raiseAmount < gameState.MinRaise && myBalance > gameState.MinRaise)
                        raiseAmount = gameState.MinRaise;

                    hubConnection?.InvokeAsync("SendAction", currentUserName, Poker.Game.Table.Decision.Raise, raiseAmount);
                }
                OffButton(Button.Raise);
                rising = false;
                break;
            case Button.Show:
                JS.InvokeVoidAsync("playAudio", "sounds/click.mp3");
                showButtonImage = "images/buttons/showClick.png";
                if (gameState != null && gameState.Stage == Poker.Game.Table.GameStage.GameOver)
                {
                    hubConnection?.InvokeAsync("SendAction", currentUserName, Poker.Game.Table.Decision.Show, 0);
                }
                break;
            case Button.Hide:
                JS.InvokeVoidAsync("playAudio", "sounds/click.mp3");
                hideButtonImage = hidden ? "images/buttons/shown.png" : "images/buttons/hidden.png";
                hidden = !hidden;
                break;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var table = GameService.GetTable(JoinCode);

        currentUserName = HttpContextAccessor.HttpContext?.User?.Identity?.Name;
        var playerTable = GameService.GetTableByPlayer(currentUserName);

        if (table == null 
            || (table.IsFull() && !table.playersInGame.Any(p => p.name == currentUserName)) 
            || (playerTable != null && playerTable.joinCode != JoinCode))
        {
            Navigation.NavigateTo($"/");
            return;
        }

        plusMinusStep = table.buyIn / 100;

        var cookieContainer = new CookieContainer();
        var hubUrl = Navigation.ToAbsoluteUri("/pokerhub");

        if (HttpContextAccessor.HttpContext?.Request.Cookies.TryGetValue("accessToken", out var token) == true)
        {
            cookieContainer.Add(new Cookie("accessToken", token, "/", hubUrl.Host));
        }

        hubConnection = new HubConnectionBuilder()
            .WithUrl(hubUrl, options =>
            {
                options.Cookies = cookieContainer;
            })
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<GameStateDto>("UpdateState", (state) =>
        {
            gameState = state;
            if (gameState.CurrentPlayer != null)
            {
                if (gameState.CurrentPlayer.name != whoseTurn)
                {
                    if (currentUserName == gameState.CurrentPlayer.name)
                    {
                        JS.InvokeVoidAsync("playAudio", "sounds/yourTurn.mp3");
                    }
                    else if(whoseTurn != currentUserName)
                    {
                        JS.InvokeVoidAsync("playAudio", "sounds/nextPlayer.mp3");
                    }
                }
                whoseTurn = gameState.CurrentPlayer.name;
            }
            else {
                whoseTurn = string.Empty;
            }
            OffButton(Button.Start);
            OffButton(Button.CheckCall);
            OffButton(Button.Raise);
            OffButton(Button.Fold);
            OffButton(Button.Show);
            OffButton(Button.Cancel);
            OffButton(Button.Minus);
            OffButton(Button.Plus);
            OffButton(Button.Ok);
            if(gameState.Players.FirstOrDefault(p => p.name == currentUserName) == null)
            {
				Navigation.NavigateTo($"/");
            }
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<string>("PlayerJoined", (playerName) =>
        {
            Console.WriteLine($"Player {playerName} joined table.");
        });

        hubConnection.On<string>("PlayerLeft", (playerName) =>
        {
            Console.WriteLine($"Player {playerName} left table.");
		});

        try
        {
            await hubConnection.StartAsync();
            await hubConnection.InvokeAsync("JoinTable", JoinCode);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SignalR Connection Error: {ex.Message}");
            Navigation.NavigateTo($"/");
            return;
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}